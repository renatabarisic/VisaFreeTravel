<!DOCTYPE html>
<html>
  <head>
    <title>Visa Free Travel</title>
    <link rel="icon" href="images/plane.png" type="image/x-icon" />
    <meta charset="utf-8" />
    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      .heading {
        font-size: 48px;
        border-bottom: 3px solid black;
        margin-top: 0px;
        padding: 20px 0px;
      }
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .map-switcher {
        margin-bottom: 20px;
      }
      .map-container {
        position: relative;
        cursor: grab;
      }
      .map-container:active {
        cursor: grabbing;
      }
      .map-heading {
        width: 1000px;
        display: flex;
        justify-content: space-between;
      }
      .zoom-button {
        border: 0px;
        border-radius: 100%;
        background-color: black;
        color: white;
        font-size: 16px;
      }
      .zoom-button:hover {
        cursor: pointer;
        background-color: #2b2b2b;
      }
      .hidden {
        display: none;
      }
      .country:hover {
        fill: #ffccd4;
        cursor: pointer;
      }
      .tooltip {
        position: absolute;
        pointer-events: none;
        background-color: #000000e6;
        color: white;
        padding: 6px;
        font-size: 12px;
        border-radius: 6px;
        display: none;
        z-index: 9999;
      }
      .footer {
        margin-top: 20px;
        padding: 20px 0px;
        border-top: 2px solid black;
      }
    </style>
  </head>
  <div class="tooltip" id="tooltip"></div>
  <body>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto&display=swap");
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <h1 class="heading">
      <span class="heading-icon">&#x2708;</span>
      Visa Free Travel
    </h1>
    <div class="content">
      <div class="map-heading">
        <div class="map-switcher" id="mapSwitcher">
          <label>
            <input type="radio" name="mapType" value="flow" checked /> Flow Map
          </label>
          <label>
            <input type="radio" name="mapType" value="proportional" />
            Proportional Symbol Map
          </label>
        </div>
        <div id="zoomButtons">
          <button class="zoom-button" id="zoomInButton">+</button>
          <button class="zoom-button" id="zoomOutButton">-</button>
        </div>
      </div>
      <div class="map-container" id="mapContainer">
        <svg id="flowMap"></svg>
        <svg class="hidden" id="proportionalMap"></svg>
      </div>
    </div>
    <footer class="footer">© 2023, Renata Barišić</footer>
    <script>
      var width = 1000;
      var height = 500;

      var container = d3.select("#mapContainer");

      var flowMap = d3
        .select("#flowMap")
        .attr("width", width)
        .attr("height", height)
        .style("background", "#AFEEEE");

      var proportionalMap = d3
        .select("#proportionalMap")
        .attr("width", width)
        .attr("height", height)
        .style("background", "#AFEEEE");

      var connectionsData = [];

      var connectionPaths;

      var curveFunction = function (source, target) {
        var dx = target.x - source.x,
          dy = target.y - source.y,
          dr = Math.sqrt(dx * dx + dy * dy);

        return (
          "M" +
          source.x +
          "," +
          source.y +
          "A" +
          dr +
          "," +
          dr +
          " 0 0,1 " +
          target.x +
          "," +
          target.y
        );
      };

      d3.json("world-map.geojson")
        .then(function (worldMap) {
          var projection = d3.geoMercator().fitSize([width, height], worldMap);
          var path = d3.geoPath().projection(projection);

          flowMap
            .selectAll("path")
            .data(worldMap.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("class", "country")
            .attr("fill", "#FFB6C1")
            .attr("stroke", "white")
            .attr("stroke-width", 0.5)
            .on("mouseover", function (event, d) {
              var countryName = d.properties.name;
              showTooltip(event.pageX, event.pageY, countryName);
            })
            .on("mouseout", function () {
              hideTooltip();
            })
            .on("click", function (event, d) {
              var clickedCountry = d.properties.name;

              var filteredConnections = connectionsData.filter(function (
                connection
              ) {
                return (
                  connection.sourceCountry === clickedCountry ||
                  connection.targetCountry === clickedCountry
                );
              });

              connectionPaths.attr("visibility", function (d) {
                return filteredConnections.includes(d) ? "visible" : "hidden";
              });
            });

          var zoomScale = 0.4;

          proportionalMap
            .selectAll("path")
            .data(worldMap.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("class", "country")
            .attr("fill", "#FFB6C1")
            .attr("stroke", "white")
            .attr("stroke-width", 0.5)
            .on("mouseover", function (event, d) {
              var countryName = d.properties.name;
              showTooltip(event.pageX, event.pageY, countryName);
            })
            .on("mouseout", function () {
              hideTooltip();
            });

          d3.json("visa-data.json")
            .then(function (visaData) {
              proportionalMap
                .selectAll("circle")
                .data(visaData)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                  return projection([d.long, d.lat])[0];
                })
                .attr("cy", function (d) {
                  return projection([d.long, d.lat])[1];
                })
                .attr("r", function (d) {
                  return Math.sqrt(d.connections.length) * (1 / zoomScale);
                })
                .attr("class", "country-circle")
                .attr("fill", "steelblue")
                .attr("fill-opacity", 0.5)
                .attr("stroke", "steelblue")
                .attr("stroke-opacity", 1)
                .on("mouseover", function (event, d) {
                  var countryName = d.country_name;
                  showTooltip(event.pageX, event.pageY, countryName);
                })
                .on("mouseout", function () {
                  hideTooltip();
                });

              visaData.forEach(function (d) {
                var sourceCoords = projection([d.long, d.lat]);

                d.connections.forEach(function (country) {
                  var target = visaData.find(function (d) {
                    return d.country_name === country;
                  });

                  if (target) {
                    var targetCoords = projection([target.long, target.lat]);

                    connectionsData.push({
                      source: {
                        x: sourceCoords[0],
                        y: sourceCoords[1],
                      },
                      target: {
                        x: targetCoords[0],
                        y: targetCoords[1],
                      },
                      sourceCountry: d.country_name,
                      targetCountry: target.country_name,
                    });
                  } else {
                    console.log("Target country not found:", country);
                  }
                });
              });

              connectionPaths = flowMap
                .selectAll(".connection")
                .data(connectionsData)
                .enter()
                .append("path")
                .attr("class", "connection")
                .attr("d", function (d) {
                  return curveFunction(d.source, d.target);
                })
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-opacity", 1)
                .attr("stroke-width", Math.sqrt(1 / zoomScale))
                .attr("visibility", "hidden");
            })
            .catch(function (error) {
              console.error("Error loading visa data:", error);
            });
        })
        .catch(function (error) {
          console.error("Error loading world map data:", error);
        });

      var mapSwitcher = document.getElementById("mapSwitcher");
      var flowMapElement = document.getElementById("flowMap");
      var proportionalMapElement = document.getElementById("proportionalMap");

      mapSwitcher.addEventListener("change", function () {
        var selectedMapType = document.querySelector(
          'input[name="mapType"]:checked'
        ).value;

        if (selectedMapType === "flow") {
          flowMapElement.classList.remove("hidden");
          proportionalMapElement.classList.add("hidden");
        } else if (selectedMapType === "proportional") {
          flowMapElement.classList.add("hidden");
          proportionalMapElement.classList.remove("hidden");
        }
      });

      function showTooltip(x, y, text) {
        var tooltip = document.getElementById("tooltip");
        tooltip.innerHTML = text;
        tooltip.style.left = event.pageX + "px";
        tooltip.style.top = event.pageY + "px";
        tooltip.style.display = "block";
      }

      function hideTooltip() {
        var tooltip = document.getElementById("tooltip");
        tooltip.style.display = "none";
      }

      var zoom = d3.zoom().on("zoom", zoomed);
      flowMap.call(zoom);
      proportionalMap.call(zoom);

      function zoomed(event) {
        zoomScale = event.transform.k;
        flowMap.selectAll(".country").attr("transform", event.transform);
        proportionalMap
          .selectAll(".country")
          .attr("transform", event.transform);
        proportionalMap
          .selectAll(".country-circle")
          .attr("transform", event.transform)
          .attr("r", function (d) {
            return Math.sqrt(d.connections.length) * (1 / zoomScale) * 2.5;
          });
        connectionPaths
          .attr("transform", event.transform)
          .attr("stroke-width", function (d) {
            return Math.sqrt(1 / zoomScale);
          });
      }

      document
        .getElementById("zoomInButton")
        .addEventListener("click", function () {
          var currentTransform = d3.zoomTransform(flowMap.node());
          var newScale = currentTransform.k * 1.2;
          var newTransform = d3.zoomIdentity
            .translate(currentTransform.x, currentTransform.y)
            .scale(newScale);
          flowMap.transition().duration(300).call(zoom.transform, newTransform);
          proportionalMap
            .transition()
            .duration(300)
            .call(zoom.transform, newTransform);
        });

      document
        .getElementById("zoomOutButton")
        .addEventListener("click", function () {
          var currentTransform = d3.zoomTransform(flowMap.node());
          var newScale = currentTransform.k / 1.2;
          var newTransform = d3.zoomIdentity
            .translate(currentTransform.x, currentTransform.y)
            .scale(newScale);
          flowMap.transition().duration(300).call(zoom.transform, newTransform);
          proportionalMap
            .transition()
            .duration(300)
            .call(zoom.transform, newTransform);
        });
    </script>
  </body>
</html>
